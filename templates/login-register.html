<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalakosh Event Registration</title>
    <!-- Link to your custom lrstyle.css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='lrstyle.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/boxicons@latest/css/boxicons.min.css">
    <!-- Google Fonts for Kalakosh branding -->
    <link href="https://fonts.googleapis.com/css2?family=Mukta:wght@400;700&family=Quintessential&display=swap" rel="stylesheet">
    <style>
        /* Custom Fonts */
        .font-mukta { font-family: 'Mukta', sans-serif; }
        .font-quintessential { font-family: 'Quintessential', cursive; }

        /* General styles for message display */
        .message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    
    <main>
        <div class="registration-container">
            <h1 class="font-quintessential">Register Now</h1>
            <p class="tagline">Join us in reviving the traditional roots of Indian Art</p>

            <div id="event-details-display" class="mb-6 p-4 bg-gray-50 rounded-lg shadow-sm border border-gray-200">
                <h3 class="text-xl font-semibold mb-2 font-quintessential" id="event-title-display">Loading Event...</h3>
                <p class="text-gray-700 text-sm mb-1" id="event-date-display">Date: </p>
                <p class="text-gray-700 text-sm mb-1" id="event-time-display">Time: </p>
                <p class="text-gray-700 text-sm mb-1" id="event-location-display">Location: </p>
                <p class="text-gray-700 text-sm mb-1" id="event-type-display">Type: </p>
                <!-- <p class="text-gray-700 text-sm mb-1" id="event-price-display">Price: </p> -->
                <p class="text-red-500 text-sm mt-2 hidden" id="event-load-error">Error loading event details.</p>
            </div>

            <form id="registration-form" class="registration-form">
                <label for="name">Full Name:</label>
                <input type="text" id="name" name="name" required>

                <label for="email">Email Address:</label>
                <input type="email" id="email" name="email" required>

                <label for="phone">Phone Number:</label>
                <input type="tel" id="phone" name="phone" required>

                <label for="city">City:</label>
                <input type="text" id="city" name="city" required>

                <button type="submit">Complete Registration</button>
                <p id="registration-message" class="message"></p>
            </form>
        </div>
    </main>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your Firebase project configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDQuFoRR5n9nvx0nq2HnbJlHQlugcd1jfM",
            authDomain: "kalakosh-website-bd6a6.firebaseapp.com",
            projectId: "kalakosh-website-bd6a6",
            storageBucket: "kalakosh-website-bd6a6.firebasestorage.app",
            messagingSenderId: "1093917835204",
            appId: "1:1093917835204:web:d93e71b98c03393cb0ae91",
            measurementId: "G-F7N10Z0RGC"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let currentUserId = null;
        let selectedEvent = null; // To store the event details being registered for

        const registrationForm = document.getElementById('registration-form');
        const nameInput = document.getElementById('name');
        const emailInput = document.getElementById('email');
        const phoneInput = document.getElementById('phone');
        const cityInput = document.getElementById('city');
        const registrationMessage = document.getElementById('registration-message');

        const eventTitleDisplay = document.getElementById('event-title-display');
        const eventDateDisplay = document.getElementById('event-date-display');
        const eventTimeDisplay = document.getElementById('event-time-display');
        const eventLocationDisplay = document.getElementById('event-location-display');
        const eventTypeDisplay = document.getElementById('event-type-display');
        // const eventPriceDisplay = document.getElementById('event-price-display');
        const eventLoadError = document.getElementById('event-load-error');

        // Function to load event details based on URL parameter
        async function loadEventDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('event_id');

            if (!eventId) {
                eventLoadError.textContent = "No event selected for registration. Please go back to the events page.";
                eventLoadError.classList.remove('hidden');
                registrationForm.style.display = 'none'; // Hide form if no event ID
                return;
            }

            if (!db || !currentAppId) {
                eventLoadError.textContent = "Firebase not initialized. Cannot load event details.";
                eventLoadError.classList.remove('hidden');
                registrationForm.style.display = 'none';
                return;
            }

            try {
                const eventRef = doc(db, `artifacts/${currentAppId}/public/data/events`, eventId);
                const eventSnap = await getDoc(eventRef);

                if (eventSnap.exists()) {
                    selectedEvent = { id: eventSnap.id, ...eventSnap.data() };
                    eventTitleDisplay.textContent = selectedEvent.title;
                    eventDateDisplay.textContent = `Date: ${selectedEvent.date}`;
                    eventTimeDisplay.textContent = `Time: ${selectedEvent.time}`;
                    eventLocationDisplay.textContent = `Location: ${selectedEvent.location}`;
                    eventTypeDisplay.textContent = `Type: ${selectedEvent.type}`;
                    // eventPriceDisplay.textContent = `Price: ${selectedEvent.price === 'Free' ? 'Free' : `â‚¹${selectedEvent.price}`}`;
                    eventLoadError.classList.add('hidden');
                    registrationForm.style.display = 'block'; // Show form
                } else {
                    eventLoadError.textContent = "Event not found. It might have been removed or the ID is incorrect.";
                    eventLoadError.classList.remove('hidden');
                    registrationForm.style.display = 'none';
                }
            } catch (error) {
                console.error("Error loading event details:", error);
                eventLoadError.textContent = `Error loading event details: ${error.message}`;
                eventLoadError.classList.remove('hidden');
                registrationForm.style.display = 'none';
            }
        }

        // Handle registration form submission
        registrationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            registrationMessage.textContent = '';
            registrationMessage.className = 'message';

            if (!currentUserId) {
                registrationMessage.textContent = "You must be logged in to register for an event. Redirecting to login...";
                registrationMessage.classList.add('error');
                setTimeout(() => {
                    window.location.href = "{{ url_for('login') }}"; // Redirect to your login page
                }, 2000);
                return;
            }

            if (!selectedEvent) {
                registrationMessage.textContent = "No event selected for registration. Please try again from the events page.";
                registrationMessage.classList.add('error');
                return;
            }

            const registrationData = {
                userId: currentUserId,
                eventId: selectedEvent.id,
                eventTitle: selectedEvent.title,
                eventDate: selectedEvent.date,
                eventTime: selectedEvent.time,
                eventLocation: selectedEvent.location,
                // eventPrice: selectedEvent.price,
                userName: nameInput.value,
                userEmail: emailInput.value,
                userPhone: phoneInput.value,
                userCity: cityInput.value,
                registrationDate: serverTimestamp()
            };

            try {
                // Save registration to the user's private collection
                const userRegistrationsRef = collection(db, `artifacts/${currentAppId}/users/${currentUserId}/registeredEvents`);
                await addDoc(userRegistrationsRef, registrationData);

                registrationMessage.textContent = "Successfully registered for the event!";
                registrationMessage.classList.add('success');
                registrationForm.reset(); // Clear form
                console.log("Event registered:", registrationData);

                // Optional: Redirect to user dashboard after a short delay
                setTimeout(() => {
                    window.location.href = "{{ url_for('index') }}";
                }, 2000);

            } catch (error) {
                console.error("Error saving registration:", error);
                registrationMessage.textContent = `Registration failed: ${error.message}`;
                registrationMessage.classList.add('error');
            }
        });

        // Initialize Firebase and load event details on page load
        window.onload = () => {
            // Check auth state first
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    emailInput.value = user.email || ''; // Pre-fill email if available from auth
                } else {
                    // If not logged in, prompt to login
                    registrationMessage.textContent = "Please log in to register for events. Redirecting to login...";
                    registrationMessage.classList.add('error');
                    setTimeout(() => {
                        window.location.href = "{{ url_for('login') }}";
                    }, 2000);
                    return; // Stop execution if not logged in
                }
                loadEventDetails(); // Load event details only after auth state is known
            });
        };
    </script>
</body>
</html>
